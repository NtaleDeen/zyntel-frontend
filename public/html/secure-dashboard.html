<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zyntel - Consolidated Dashboard</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@latest/dist/chartjs-adapter-moment.min.js"></script>

    <style>
      /* --- Merged CSS from general.css, index.css, and tat.css --- */
      @import url("https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap");

      * {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
        font-family: "Roboto", sans-serif;
        color: var(--main-color);
      }

      :root {
        --main-color: #21336a;
        --primary-color: #000;
        --canvas-color: #fff;
        --hover-color: #deab5f;
        --background-color: rgba(250, 250, 250, 0.9);
        --border-bottom: rgb(228, 228, 228);
        --box-shadow: rgba(0, 0, 0, 0.05);
        --light-grey-background: #f0f0f0;
      }

      html {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      body {
        margin: 0;
        padding-top: 150px;
        background-color: #f4f4f4;
        min-height: 100vh;
      }

      /* Login Page Styles (from index.css) */
      .login-container {
        display: grid;
        grid-template-columns: 50% 50%;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        padding: 30px 50px;
        box-sizing: border-box;
        column-gap: 30px;
        min-height: 100vh;
        background-color: #0a0a0a;
        margin-top: -150px; /* Counteract the body padding */
      }
      .image-column {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      .full-height-image {
        max-width: 100%;
        width: 500px;
        height: auto;
        object-fit: contain;
      }
      .login-column {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }
      .login-box {
        text-align: center;
        padding: 40px 30px;
        border-radius: 20px;
        background-color: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        box-shadow: 0 0 40px rgba(125, 225, 154, 0.7);
        width: 100%;
        max-width: 400px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: glowing 15s infinite;
      }
      .login-box h1 {
        font-family: "Times New Roman", Times, serif;
        font-size: 3em;
        margin: 0 0 5px;
        color: #fff;
        font-weight: 500;
      }
      .login-box p {
        color: #ddd;
        margin-bottom: 25px;
      }
      .logo-container {
        position: relative;
        width: 100px;
        height: 100px;
        margin: 0 auto 20px;
      }
      .logo-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: absolute;
        top: 0;
        left: 0;
      }
      .input-group {
        margin-bottom: 20px;
      }
      .input-group input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #4caf50;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
        font-size: 16px;
        transition: border-color 0.3s;
      }
      .input-group input::placeholder {
        color: #aaa;
      }
      .input-group input:focus {
        outline: none;
        border-color: #81c784;
      }
      .info-line {
        font-size: 14px;
        color: #aaa;
        margin-bottom: 20px;
      }
      button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-bottom: 15px;
      }
      .login-button {
        background-color: #4caf50;
        color: white;
      }
      .login-button:hover {
        background-color: rgba(76, 175, 80, 0.2);
      }
      .buy-package-button {
        background: none;
        border: 1px solid #4caf50;
        color: #4caf50;
      }
      .buy-package-button:hover {
        background-color: rgba(76, 175, 80, 0.2);
      }
      .help-info {
        font-size: 13px;
        color: #999;
        margin-top: 20px;
      }
      .hidden {
        display: none !important;
      }

      /* Dashboard/Page Header Styles */
      header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        background-color: var(--background-color);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        height: 90px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
      }

      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      .header-left {
        display: flex;
        align-items: center;
      }

      .logo img {
        height: 60px;
      }

      .header-left h1 {
        margin-left: 20px;
        font-size: 1.5rem;
      }

      .navbar a {
        padding: 10px 15px;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.3s;
      }

      .navbar a:hover {
        color: var(--hover-color);
      }

      .navbar a.active {
        color: var(--hover-color);
      }

      /* Main Content Layout */
      main {
        display: flex;
        flex-direction: column;
        padding: 20px;
        flex-grow: 1;
      }

      /* KPI Grid Styles (from tat.css) */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .kpi-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .kpi-label {
        font-size: 1.2rem;
        color: #555;
      }

      .kpi-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--main-color);
      }

      .kpi-trend {
        font-size: 0.9rem;
        color: #888;
      }

      /* Chart Container Styles */
      .dashboard-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      /* Filters Styles */
      .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        justify-content: center;
        align-items: center;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-group label {
        font-size: 0.9rem;
        color: #555;
      }

      .filter-group select,
      .filter-group input {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <!-- Login Page View -->
    <div id="login-view" class="login-container">
      <div class="image-column">
        <img
          src="https://placehold.co/500x500/0a0a0a/ffffff?text=Zyntel_Logo"
          alt="Zyntel Icon"
          class="full-height-image"
        />
      </div>

      <div class="login-column">
        <div class="login-box">
          <div class="logo-container">
            <img
              id="pulsingIcon"
              src="https://placehold.co/100x100/7de19a/ffffff?text=Zyntel"
              alt="Zyntel Icon"
            />
          </div>
          <h1>Zyntel</h1>
          <p>Data Analysis Experts</p>

          <form id="loginForm">
            <div class="input-group">
              <input type="text" placeholder="Username" id="username" required />
            </div>
            <div class="input-group">
              <input
                type="password"
                placeholder="Password"
                id="password"
                required
              />
            </div>
            <div id="message" style="margin-bottom: 15px;"></div>
            <button type="submit" class="login-button">Login</button>
          </form>

          <button class="buy-package-button">Visit Our Website</button>

          <div class="help-info">
            <p>
              Forgot your password?
              <a href="#">Contact Support</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Dashboard Application View -->
    <div id="app-view" class="hidden">
      <header>
        <div class="header-container">
          <div class="header-left">
            <div class="logo">
              <img
                src="https://placehold.co/60x60/f4f4f4/21336a?text=NHL"
                alt="logo"
              />
            </div>
            <h1>NHL Laboratory Dashboard</h1>
          </div>
          <nav class="navbar">
            <a href="#" id="nav-dashboard" class="active">Dashboard</a>
            <a href="#" id="nav-revenue">Revenue</a>
            <a href="#" id="nav-tat">TAT</a>
            <a href="#" id="nav-logout">Logout</a>
          </nav>
        </div>
      </header>

      <main>
        <!-- Content for different pages will be loaded here -->
        <div id="dashboard-content">
          <h1>Welcome to the Dashboard!</h1>
          <p>This is the landing page. You can add new sections here.</p>
        </div>
        <div id="revenue-content" class="hidden">
          <div class="filters-container">
            <div class="filter-group">
              <label for="startDateFilter">Start Date</label>
              <input type="date" id="startDateFilter" />
            </div>
            <div class="filter-group">
              <label for="endDateFilter">End Date</label>
              <input type="date" id="endDateFilter" />
            </div>
            <div class="filter-group">
              <label for="periodSelect">Period</label>
              <select id="periodSelect">
                <option value="">Select Period</option>
                <option value="thisMonth">This Month</option>
                <option value="lastMonth">Last Month</option>
                <option value="thisQuarter">This Quarter</option>
                <option value="lastQuarter">Last Quarter</option>
                <option value="thisYear">This Year</option>
                <option value="lastYear">Last Year</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="labSectionFilter">Lab Section</label>
              <select id="labSectionFilter">
                <option value="">All Sections</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="shiftFilter">Shift</label>
              <select id="shiftFilter">
                <option value="">All Shifts</option>
                <option value="morning">Morning</option>
                <option value="evening">Evening</option>
                <option value="night">Night</option>
              </select>
            </div>
          </div>
          <div class="dashboard-charts">
            <div class="chart-container">
              <canvas id="hospitalUnitRevenueChart"></canvas>
            </div>
            <div class="chart-container">
              <label for="unitSelect" class="unitSelect-label"
                >Select Hospital Unit:</label
              >
              <select id="unitSelect"></select>
              <canvas id="topTestsChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="testRevenueChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="testCountChart"></canvas>
            </div>
          </div>
        </div>
        <div id="tat-content" class="hidden">
          <div class="filters-container">
            <div class="filter-group">
              <label for="startDateFilterTat">Start Date</label>
              <input type="date" id="startDateFilterTat" />
            </div>
            <div class="filter-group">
              <label for="endDateFilterTat">End Date</label>
              <input type="date" id="endDateFilterTat" />
            </div>
            <div class="filter-group">
              <label for="periodSelectTat">Period</label>
              <select id="periodSelectTat">
                <option value="">Select Period</option>
                <option value="thisMonth">This Month</option>
                <option value="lastMonth">Last Month</option>
                <option value="thisQuarter">This Quarter</option>
                <option value="lastQuarter">Last Quarter</option>
                <option value="thisYear">This Year</option>
                <option value="lastYear">Last Year</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="labSectionFilterTat">Lab Section</label>
              <select id="labSectionFilterTat">
                <option value="">All Sections</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="unitTypeFilterTat">Unit Type</label>
              <select id="unitTypeFilterTat">
                <option value="">All Units</option>
                <option value="inpatient">Inpatient</option>
                <option value="outpatient">Outpatient</option>
                <option value="annex">Annex</option>
              </select>
            </div>
          </div>
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-label">Average TAT</div>
              <div class="kpi-value" id="avgTAT">N/A</div>
              <div class="kpi-trend" id="avgTATTrend"></div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">On-Time Rate</div>
              <div class="kpi-value" id="onTimeRate">N/A</div>
              <div class="kpi-trend" id="onTimeRateTrend"></div>
            </div>
            <div class="kpi-card kpi-card-full-width">
              <div class="kpi-label">Most Delayed Day</div>
              <div class="kpi-value" id="mostDelayedDay">N/A</div>
              <div class="kpi-trend" id="mostDelayedDayTrend"></div>
            </div>
          </div>
          <div class="dashboard-charts">
            <div class="chart-container">
              <canvas id="tatPieChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="tatLineChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="tatHourlyLineChart"></canvas>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // --- Merged JavaScript Logic ---

      // Global chart instances to ensure they can be destroyed and recreated
      let revenueCharts = {};
      let tatCharts = {};
      let allData = [];
      let filteredData = [];

      // API Endpoints
      const API_URL_REVENUE = "https://zyntel-data-updater.onrender.com/api/revenue-data";
      const API_URL_TAT = "https://zyntel-data-updater.onrender.com/api/performance-data";
      const BACKEND_URL = "https://zyntel-data-updater.onrender.com"; // For login

      // UI Elements
      const loginView = document.getElementById("login-view");
      const appView = document.getElementById("app-view");
      const dashboardContent = document.getElementById("dashboard-content");
      const revenueContent = document.getElementById("revenue-content");
      const tatContent = document.getElementById("tat-content");
      const messageDiv = document.getElementById("message");

      // Register the datalabels plugin globally
      Chart.register(ChartDataLabels);

      // --- Utility Functions ---

      // Unit definitions (from filters-tat.js and revenue.js)
      const inpatientUnits = ["APU", "GWA", "GWB", "HDU", "ICU", "MAT", "NICU", "THEATRE"];
      const outpatientUnits = ["2ND FLOOR", "A&E", "DIALYSIS", "DOCTORS PLAZA", "ENT", "RADIOLOGY", "SELF REQUEST", "WELLNESS", "WELLNESS CENTER"];
      const annexUnits = ["ANNEX"];
      const allHospitalUnits = [...inpatientUnits, ...outpatientUnits, ...annexUnits];
      const allLabSections = ["HEMATOLOGY", "MICROBIOLOGY", "BIOCHEMISTRY", "MOLECULAR", "HISTOLOGY", "SEROLOGY", "GENERAL"];

      function showView(viewId) {
        const views = [loginView, appView];
        views.forEach(view => view.classList.add("hidden"));
        document.getElementById(viewId).classList.remove("hidden");
      }

      function showPage(pageId) {
        const pages = [dashboardContent, revenueContent, tatContent];
        pages.forEach(page => page.classList.add("hidden"));
        document.getElementById(pageId).classList.remove("hidden");

        const navLinks = document.querySelectorAll(".navbar a");
        navLinks.forEach(link => link.classList.remove("active"));

        if (pageId === "dashboard-content") {
          document.getElementById("nav-dashboard").classList.add("active");
        } else if (pageId === "revenue-content") {
          document.getElementById("nav-revenue").classList.add("active");
          initializeRevenuePage();
        } else if (pageId === "tat-content") {
          document.getElementById("nav-tat").classList.add("active");
          initializeTATPage();
        }
      }

      function createFilterElements(filtersContainerId, pageType) {
        const filtersContainer = document.getElementById(filtersContainerId);
        if (!filtersContainer) return;

        // Date inputs and period select
        const dateFiltersHtml = `
          <div class="filter-group">
            <label for="startDateFilter${pageType}">Start Date</label>
            <input type="date" id="startDateFilter${pageType}" />
          </div>
          <div class="filter-group">
            <label for="endDateFilter${pageType}">End Date</label>
            <input type="date" id="endDateFilter${pageType}" />
          </div>
          <div class="filter-group">
            <label for="periodSelect${pageType}">Period</label>
            <select id="periodSelect${pageType}">
              <option value="">Select Period</option>
              <option value="thisMonth">This Month</option>
              <option value="lastMonth">Last Month</option>
              <option value="thisQuarter">This Quarter</option>
              <option value="lastQuarter">Last Quarter</option>
              <option value="thisYear">This Year</option>
              <option value="lastYear">Last Year</option>
            </select>
          </div>
        `;
        // Lab section filter
        const labSectionOptions = allLabSections.map(section => `<option value="${section}">${section}</option>`).join('');
        const labSectionFilterHtml = `
          <div class="filter-group">
            <label for="labSectionFilter${pageType}">Lab Section</label>
            <select id="labSectionFilter${pageType}">
              <option value="">All Sections</option>
              ${labSectionOptions}
            </select>
          </div>
        `;

        let specificFiltersHtml = '';
        if (pageType === "Tat") {
          specificFiltersHtml = `
            <div class="filter-group">
              <label for="unitTypeFilterTat">Unit Type</label>
              <select id="unitTypeFilterTat">
                <option value="">All Units</option>
                <option value="inpatient">Inpatient</option>
                <option value="outpatient">Outpatient</option>
                <option value="annex">Annex</option>
              </select>
            </div>
          `;
        } else if (pageType === "") {
          const unitOptions = allHospitalUnits.map(unit => `<option value="${unit}">${unit}</option>`).join('');
          specificFiltersHtml = `
            <div class="filter-group">
              <label for="unitSelect">Unit</label>
              <select id="unitSelect">
                <option value="">All Units</option>
                ${unitOptions}
              </select>
            </div>
            <div class="filter-group">
              <label for="shiftFilter">Shift</label>
              <select id="shiftFilter">
                <option value="">All Shifts</option>
                <option value="morning">Morning</option>
                <option value="evening">Evening</option>
                <option value="night">Night</option>
              </select>
            </div>
          `;
        }
      }

      function getSelectedFilters(pageType) {
        const startDate = document.getElementById(`startDateFilter${pageType}`).value;
        const endDate = document.getElementById(`endDateFilter${pageType}`).value;
        const period = document.getElementById(`periodSelect${pageType}`).value;
        const labSection = document.getElementById(`labSectionFilter${pageType}`).value;
        const unit = pageType === "" ? document.getElementById("unitSelect").value : null;
        const shift = pageType === "" ? document.getElementById("shiftFilter").value : null;
        const unitType = pageType === "Tat" ? document.getElementById("unitTypeFilterTat").value : null;

        return { startDate, endDate, period, labSection, unit, shift, unitType };
      }

      function updateDatesForPeriod(period, pageType) {
        const nowEAT = moment().tz("Africa/Nairobi");
        let startDate, endDate;

        switch (period) {
          case "thisMonth":
            startDate = nowEAT.clone().startOf("month");
            endDate = nowEAT.clone().endOf("month");
            break;
          case "lastMonth":
            startDate = nowEAT.clone().subtract(1, "month").startOf("month");
            endDate = nowEAT.clone().subtract(1, "month").endOf("month");
            break;
          case "thisQuarter":
            startDate = nowEAT.clone().startOf("quarter");
            endDate = nowEAT.clone().endOf("quarter");
            break;
          case "lastQuarter":
            startDate = nowEAT.clone().subtract(1, "quarter").startOf("quarter");
            endDate = nowEAT.clone().subtract(1, "quarter").endOf("quarter");
            break;
          case "thisYear":
            startDate = nowEAT.clone().startOf("year");
            endDate = nowEAT.clone().endOf("year");
            break;
          case "lastYear":
            startDate = nowEAT.clone().subtract(1, "year").startOf("year");
            endDate = nowEAT.clone().subtract(1, "year").endOf("year");
            break;
          default:
            return;
        }

        document.getElementById(`startDateFilter${pageType}`).value = startDate.format("YYYY-MM-DD");
        document.getElementById(`endDateFilter${pageType}`).value = endDate.format("YYYY-MM-DD");
      }

      function isDateInFilterRange(date, startDate, endDate) {
        if (!date) return false;
        const momentDate = moment(date);
        return momentDate.isSameOrAfter(startDate) && momentDate.isSameOrBefore(endDate);
      }

      // --- Page Specific Logic ---

      // Login Page Logic (from index.js)
      function initializeLoginPage() {
        const loginForm = document.getElementById("loginForm");
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");

        const iconColors = ['https://placehold.co/100x100/00f0ff/ffffff?text=Zyntel', 'https://placehold.co/100x100/ffe066/ffffff?text=Zyntel', 'https://placehold.co/100x100/7de19a/ffffff?text=Zyntel', 'https://placehold.co/100x100/c0c0c0/ffffff?text=Zyntel'];
        const glowColors = ['rgba(0, 240, 255, 0.7)', 'rgba(255, 224, 102, 0.7)', 'rgba(125, 225, 154, 0.7)', 'rgba(192, 192, 192, 0.7)'];
        let currentColorIndex = 0;
        const transitionInterval = 2000;

        function updateColors() {
          const icon = document.getElementById('pulsingIcon');
          const loginBox = document.querySelector('.login-box');
          if (icon && loginBox) {
            currentColorIndex = (currentColorIndex + 1) % iconColors.length;
            icon.src = iconColors[currentColorIndex];
            loginBox.style.boxShadow = `0 0 40px ${glowColors[currentColorIndex]}`;
          }
        }
        setInterval(updateColors, transitionInterval);
        updateColors();

        if (loginForm) {
          loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;
            messageDiv.textContent = '';

            try {
              const response = await fetch(`${BACKEND_URL}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password }),
              });
              const data = await response.json();

              if (response.ok) {
                localStorage.setItem('token', data.token);
                messageDiv.style.color = 'green';
                messageDiv.textContent = data.message + ". Redirecting...";
                showView('app-view');
                showPage('dashboard-content');
              } else {
                messageDiv.style.color = 'red';
                messageDiv.textContent = data.message || 'Login failed. Please try again.';
              }
            } catch (error) {
              console.error('Login error:', error);
              messageDiv.style.color = 'red';
              messageDiv.textContent = 'Network error. Please try again later.';
            }
          });
        }
      }

      // Revenue Page Logic (from revenue.js)
      async function fetchAndProcessRevenueData() {
        try {
          const response = await fetch(API_URL_REVENUE);
          const data = await response.json();
          allData = data.data;
          processDataForRevenue();
        } catch (error) {
          console.error("Failed to fetch revenue data:", error);
        }
      }

      function processDataForRevenue() {
        const filters = getSelectedFilters("");
        const { startDate, endDate, labSection, shift, unit } = filters;
        filteredData = allData.filter(d => {
          const date = moment(d.date_in);
          const inRange = isDateInFilterRange(d.date_in, startDate, endDate);
          const sectionMatch = labSection ? d.lab_section === labSection : true;
          const shiftMatch = shift ? d.shift === shift : true;
          const unitMatch = unit ? d.hospital_unit === unit : true;
          return inRange && sectionMatch && shiftMatch && unitMatch;
        });

        // Aggregation logic...
        // This is a placeholder, as the original file had detailed aggregation logic.
        // You would place the logic to aggregate revenue data here before drawing the charts.
        drawRevenueCharts();
      }

      function drawRevenueCharts() {
        // Destroy existing charts
        if (revenueCharts.hospitalUnitRevenueChart) revenueCharts.hospitalUnitRevenueChart.destroy();
        if (revenueCharts.topTestsChart) revenueCharts.topTestsChart.destroy();
        if (revenueCharts.testRevenueChart) revenueCharts.testRevenueChart.destroy();
        if (revenueCharts.testCountChart) revenueCharts.testCountChart.destroy();

        // Placeholder data for the charts
        const unitData = { labels: ["Unit A", "Unit B"], datasets: [{ data: [10000, 15000] }] };
        const testData = { labels: ["Test 1", "Test 2"], datasets: [{ data: [5000, 7000] }] };

        // Render charts
        const ctx1 = document.getElementById("hospitalUnitRevenueChart").getContext("2d");
        revenueCharts.hospitalUnitRevenueChart = new Chart(ctx1, { type: "bar", data: unitData });

        const ctx2 = document.getElementById("topTestsChart").getContext("2d");
        revenueCharts.topTestsChart = new Chart(ctx2, { type: "pie", data: testData });

        const ctx3 = document.getElementById("testRevenueChart").getContext("2d");
        revenueCharts.testRevenueChart = new Chart(ctx3, { type: "bar", data: unitData });

        const ctx4 = document.getElementById("testCountChart").getContext("2d");
        revenueCharts.testCountChart = new Chart(ctx4, { type: "line", data: testData });
      }

      function initializeRevenuePage() {
        const startDateFilter = document.getElementById("startDateFilter");
        const endDateFilter = document.getElementById("endDateFilter");
        const periodSelect = document.getElementById("periodSelect");
        const labSectionFilter = document.getElementById("labSectionFilter");
        const shiftFilter = document.getElementById("shiftFilter");
        const unitSelect = document.getElementById("unitSelect");

        const updateHandler = () => {
          processDataForRevenue();
        };

        if (periodSelect) {
          periodSelect.addEventListener("change", () => {
            updateDatesForPeriod(periodSelect.value, "");
            updateHandler();
          });
          periodSelect.value = "thisMonth";
          updateDatesForPeriod("thisMonth", "");
        }

        if (startDateFilter) startDateFilter.addEventListener("change", () => {
          periodSelect.value = "";
          updateHandler();
        });
        if (endDateFilter) endDateFilter.addEventListener("change", () => {
          periodSelect.value = "";
          updateHandler();
        });
        if (labSectionFilter) labSectionFilter.addEventListener("change", updateHandler);
        if (shiftFilter) shiftFilter.addEventListener("change", updateHandler);
        if (unitSelect) unitSelect.addEventListener("change", updateHandler);

        fetchAndProcessRevenueData();
      }

      // TAT Page Logic (from tat.js)
      async function fetchAndProcessTATData() {
        try {
          const response = await fetch(API_URL_TAT);
          const data = await response.json();
          allData = data.data;
          processDataForTAT();
        } catch (error) {
          console.error("Failed to fetch TAT data:", error);
        }
      }

      function processDataForTAT() {
        const filters = getSelectedFilters("Tat");
        const { startDate, endDate, labSection, unitType } = filters;
        filteredData = allData.filter(d => {
          const date = moment(d.date_in);
          const inRange = isDateInFilterRange(d.date_in, startDate, endDate);
          const sectionMatch = labSection ? d.lab_section === labSection : true;
          const unitTypeMatch = unitType ?
            (unitType === 'inpatient' && inpatientUnits.includes(d.hospital_unit)) ||
            (unitType === 'outpatient' && outpatientUnits.includes(d.hospital_unit)) ||
            (unitType === 'annex' && annexUnits.includes(d.hospital_unit)) : true;
          return inRange && sectionMatch && unitTypeMatch;
        });

        // Aggregation logic...
        // This is a placeholder. You would place the logic to aggregate TAT data here.
        // It would calculate average TAT, on-time rate, most delayed day, etc.
        drawTATCharts();
      }

      function drawTATCharts() {
        // Destroy existing charts
        if (tatCharts.tatPieChart) tatCharts.tatPieChart.destroy();
        if (tatCharts.tatLineChart) tatCharts.tatLineChart.destroy();
        if (tatCharts.tatHourlyLineChart) tatCharts.tatHourlyLineChart.destroy();

        // Placeholder data for the charts and KPIs
        const pieData = { labels: ["On Time", "Delayed"], datasets: [{ data: [75, 25], backgroundColor: ["#4CAF50", "#F44336"] }] };
        const lineData = { labels: ["Mon", "Tue", "Wed"], datasets: [{ label: "TAT Performance", data: [80, 85, 70] }] };
        document.getElementById("avgTAT").textContent = "4.5h";
        document.getElementById("onTimeRate").textContent = "75%";
        document.getElementById("mostDelayedDay").textContent = "Wednesday";

        // Render charts
        const ctx1 = document.getElementById("tatPieChart").getContext("2d");
        tatCharts.tatPieChart = new Chart(ctx1, { type: "pie", data: pieData });

        const ctx2 = document.getElementById("tatLineChart").getContext("2d");
        tatCharts.tatLineChart = new Chart(ctx2, { type: "line", data: lineData });

        const ctx3 = document.getElementById("tatHourlyLineChart").getContext("2d");
        tatCharts.tatHourlyLineChart = new Chart(ctx3, { type: "line", data: lineData });
      }

      function initializeTATPage() {
        const startDateFilter = document.getElementById("startDateFilterTat");
        const endDateFilter = document.getElementById("endDateFilterTat");
        const periodSelect = document.getElementById("periodSelectTat");
        const labSectionFilter = document.getElementById("labSectionFilterTat");
        const unitTypeFilter = document.getElementById("unitTypeFilterTat");

        const updateHandler = () => {
          processDataForTAT();
        };

        if (periodSelect) {
          periodSelect.addEventListener("change", () => {
            updateDatesForPeriod(periodSelect.value, "Tat");
            updateHandler();
          });
          periodSelect.value = "thisMonth";
          updateDatesForPeriod("thisMonth", "Tat");
        }

        if (startDateFilter) startDateFilter.addEventListener("change", () => {
          periodSelect.value = "";
          updateHandler();
        });
        if (endDateFilter) endDateFilter.addEventListener("change", () => {
          periodSelect.value = "";
          updateHandler();
        });
        if (labSectionFilter) labSectionFilter.addEventListener("change", updateHandler);
        if (unitTypeFilter) unitTypeFilter.addEventListener("change", updateHandler);

        fetchAndProcessTATData();
      }

      // --- Main Application Flow ---
      window.onload = function () {
        // Initial setup
        const token = localStorage.getItem("token");
        if (token) {
          showView('app-view');
          showPage('dashboard-content');
        } else {
          showView('login-view');
          initializeLoginPage();
        }

        // Navigation links
        document.getElementById("nav-dashboard").addEventListener("click", (e) => {
          e.preventDefault();
          showPage("dashboard-content");
        });
        document.getElementById("nav-revenue").addEventListener("click", (e) => {
          e.preventDefault();
          showPage("revenue-content");
        });
        document.getElementById("nav-tat").addEventListener("click", (e) => {
          e.preventDefault();
          showPage("tat-content");
        });
        document.getElementById("nav-logout").addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.removeItem("token");
          showView("login-view");
        });
      };
    </script>
  </body>
</html>
